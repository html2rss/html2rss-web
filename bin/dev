#!/usr/bin/env bash
# frozen_string_literal: true

set -e

# Load .env if exists
if [ -f .env ]; then
  export $(cat .env | grep -v '^#' | xargs)
fi

export RACK_ENV=${RACK_ENV:-development}

# Cleanup function for graceful shutdown
cleanup() {
  kill $RUBY_PID 2>/dev/null || true
  kill $ASTRO_PID 2>/dev/null || true
  wait $RUBY_PID 2>/dev/null || true
  wait $ASTRO_PID 2>/dev/null || true
  exit 0
}

trap cleanup SIGINT SIGTERM

# Prevent silent failures from port conflicts
if lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
  echo "❌ Port 3000 is already in use. Run: pkill -f 'puma.*html2rss-web'"
  exit 1
fi

# Start Ruby server
bundle exec puma -p 3000 -C config/puma.rb &
RUBY_PID=$!

# Verify Ruby server started successfully
sleep 3
if ! kill -0 $RUBY_PID 2>/dev/null || ! lsof -Pi :3000 -sTCP:LISTEN -t >/dev/null 2>&1; then
  echo "❌ Ruby server failed to start"
  exit 1
fi

# Start Astro dev server
cd frontend
npm run dev &
ASTRO_PID=$!

# Verify Astro server started
sleep 3
if ! kill -0 $ASTRO_PID 2>/dev/null; then
  echo "❌ Astro dev server failed to start"
  kill $RUBY_PID 2>/dev/null || true
  exit 1
fi

echo "✅ Development environment ready at http://localhost:3001"
wait $RUBY_PID $ASTRO_PID
