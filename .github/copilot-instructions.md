# html2rss-web AI Agent Instructions

## Overview

- Ruby web app that converts websites into RSS 2.0 feeds.
- Built with **Roda** backend + **Astro** frontend, using the **html2rss** gem (+ `html2rss-configs`).
- **Principle:** _All features must work without JavaScript._ JS is only progressive enhancement.
- **Frontend:** Modern Astro-based UI with component architecture, served alongside Ruby backend.

## Documentation website of core dependencies

Search these pages before using them. Find examples, plugins, UI components, and configuration options.

### Roda

1. https://roda.jeremyevans.net/documentation.html

### Astro & Starlight

1. https://docs.astro.build/en/getting-started/
2. https://starlight.astro.build/getting-started/

### html2rss

1. If available, find source locally in: `../html2rss`.
2. source code on github: https://github.com/html2rss/html2rss

### Test and Linters

1. https://docs.rubocop.org/rubocop/cops.html
2. https://docs.rubocop.org/rubocop-rspec/cops_rspec.html
3. https://rspec.info/features/3-13/rspec-expectations/built-in-matchers/
4. https://www.betterspecs.org/

## Core Rules

- ✅ Use **Roda routing with `hash_branch`**. Keep routes small.
- ✅ Put logic into `helpers/` or `app/`, not inline in routes.
- ✅ Validate all inputs. Pass outbound requests through **SSRF filter**.
- ✅ Add caching headers where appropriate (`Rack::Cache`).
- ✅ Errors: friendly messages for users, detailed logging internally.
- ✅ **Frontend**: Use Astro components in `frontend/src/`. Keep it simple.
- ✅ **CSS**: Use frontend styles in `frontend/public/styles.css`. Water.css for fallback.
- ✅ **Specs**: RSpec for Ruby, build tests for frontend.

## Roda Large Applications Structure

This project follows [Roda Large Applications conventions](https://roda.jeremyevans.net/rdoc/files/doc/conventions_rdoc.html#label-Large+Applications):

- **Use `hash_branches` plugin** (not `hash_branch_view_subdir` since we have no views)
- **Route modules** go in `routes/` directory (one file per prefix)
- **Helper modules** go in `helpers/` directory with `module_function`
- **Core app modules** stay in `app/` directory
- **Load routes/helpers** with `Dir['routes/*.rb'].each { |f| require_relative f }`

## Don't

- ❌ Don't depend on JS for core flows.
- ❌ Don't bypass SSRF filter or weaken CSP.
- ❌ Don't add databases, ORMs, or background jobs.
- ❌ Don't leak stack traces or secrets in responses.
- ❌ Don't add complex frontend frameworks (React, Vue, etc.). Keep Astro simple.
- ❌ Don't modify `frontend/dist/` - it's generated by build process.
- ❌ NEVER expose the auth token a user provides.

## Project Structure

- `app.rb` – main Roda app
- `app/` – core modules (config, cache, ssrf, health)
- `routes/` – route handlers (`hash_branch`)
- `helpers/` – pure helper modules (`module_function`)
- `views/` – ERB templates (fallback)
- `public/` – static assets (CSS/JS, minimal)
- `frontend/` – Astro frontend application
  - `src/pages/` – Astro pages (index.astro, gallery.astro)
  - `src/layouts/` – Astro layouts (Layout.astro)
  - `public/` – frontend static assets
  - `package.json` – Node.js dependencies
  - `astro.config.mjs` – Astro configuration
- `config/feeds.yml` – feed definitions
- `spec/` – RSpec tests + VCR cassettes

## Environment

- `RACK_ENV` – environment
- `AUTO_SOURCE_ENABLED`, `AUTO_SOURCE_USERNAME`, `AUTO_SOURCE_PASSWORD`, `AUTO_SOURCE_ALLOWED_ORIGINS`
- `HEALTH_CHECK_USERNAME`, `HEALTH_CHECK_PASSWORD`
- `SENTRY_DSN` (optional)

### Verification Steps
- Run `ruby -c app.rb` to check syntax
- Run `bundle exec rspec` to verify tests
- Check `bundle install` removes unused dependencies

## Style

- Add `# frozen_string_literal: true`
- Follow RuboCop style
- YARD doc comments for public methods
